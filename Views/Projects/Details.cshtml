@model TaskManagementSystem.Models.Project

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf
@{
    var antiforgeryTokenSet = Xsrf.GetAndStoreTokens(Context);
    ViewData["Title"] = "Project Details";

    var todoCount = Model.Task.Count(t => t.Status == "To Do");
    var inProgressCount = Model.Task.Count(t => t.Status == "In Progress");
    var doneCount = Model.Task.Count(t => t.Status == "Done");
}

<div style="position: relative;">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#updateProjectModal"
            style="position: absolute; top: 0; right: 0;">
        Update Project
    </button>
</div>

<h2>@Model.Name</h2>
<p>@Model.Description</p>

<!-- Bootstrap Modal for Update Project -->
<div class="modal fade" id="updateProjectModal" tabindex="-1" aria-labelledby="updateProjectModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateProjectModalLabel">Update Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form asp-action="Edit" method="post">
                    <input type="hidden" asp-for="Project_id" />
                    <div class="mb-3">
                        <label asp-for="Name" class="form-label">Project Name</label>
                        <input asp-for="Name" class="form-control" />
                    </div>
                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">Description</label>
                        <textarea asp-for="Description" class="form-control"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<h3>Tasks</h3>
<div class="row">
    <div class="col-md-4 border-end">
        <h4 id="todoCountHeader">To Do (@todoCount)</h4>

        <div id="todoColumn" class="task-column">
            @foreach (var task in Model.Task.Where(t => t.Status == "To Do"))
            {
                <div class="card-body" data-task-id="@task.Task_id">
                    <h5 class="card-title">@task.Title</h5>
                    <h6 class="card-subtitle mb-2 text-muted">@task.AssignedUser?.UserName</h6>
                    <p class="card-text">@task.Description</p>
                    <p class="card-text"><small class="text-muted">Created At: @task.CreateAt</small></p>
                    <p class="card-text"><small class="text-muted">Due Date: @task.DueDate.ToShortDateString()</small></p>
                    <p class="card-text">
                        <small class="text-muted">
                            Updated At: <span class="updated-at">@task.UpdateAt</span>
                        </small>
                    </p>
                    <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal"
                       data-task-id="@task.Task_id" data-status="@task.Status">Edit</a>
                    <button class="btn btn-danger delete-task-button" data-task-id="@task.Task_id">Delete</button>
                </div>

            }
        </div>
        <div class="row mx-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#taskModal"
                    data-status="To Do">
                Add Task
            </button>
        </div>
    </div>
    <div class="col-md-4 border-end">
        <h4 id="inProgressCountHeader">In Progress (@inProgressCount)</h4>
        <div id="inProgressColumn" class="task-column">
            @foreach (var task in Model.Task.Where(t => t.Status == "In Progress"))
            {
                <div class="card-body" data-task-id="@task.Task_id">
                    <h5 class="card-title">@task.Title</h5>
                    <h6 class="card-subtitle mb-2 text-muted">@task.AssignedUser?.UserName</h6>
                    <p class="card-text">@task.Description</p>
                    <p class="card-text"><small class="text-muted">Created At: @task.CreateAt</small></p>
                    <p class="card-text"><small class="text-muted">Due Date: @task.DueDate.ToShortDateString()</small></p>
                    <p class="card-text">
                        <small class="text-muted">
                            Updated At: <span class="updated-at">@task.UpdateAt</span>
                        </small>
                    </p>
                    <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal"
                       data-task-id="@task.Task_id" data-status="@task.Status">Edit</a>
                    <button class="btn btn-danger delete-task-button" data-task-id="@task.Task_id">Delete</button>
                </div>

            }
        </div>
        <div class="row mx-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#taskModal"
                    data-status="In Progress">
                Add Task
            </button>
        </div>
    </div>
    <div class="col-md-4">
        <h4 id="doneCountHeader">Done (@doneCount)</h4>
        <div id="doneColumn" class="task-column">
            @foreach (var task in Model.Task.Where(t => t.Status == "Done"))
            {
                <div class="card-body" data-task-id="@task.Task_id">
                    <h5 class="card-title">@task.Title</h5>
                    <h6 class="card-subtitle mb-2 text-muted">@task.AssignedUser?.UserName</h6>
                    <p class="card-text">@task.Description</p>
                    <p class="card-text"><small class="text-muted">Created At: @task.CreateAt</small></p>
                    <p class="card-text"><small class="text-muted">Due Date: @task.DueDate.ToShortDateString()</small></p>
                    <p class="card-text">
                        <small class="text-muted">
                            Updated At: <span class="updated-at">@task.UpdateAt</span>
                        </small>
                    </p>
                    <a class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#taskModal"
                       data-task-id="@task.Task_id" data-status="@task.Status">Edit</a>
                    <button class="btn btn-danger delete-task-button" data-task-id="@task.Task_id">Delete</button>
                </div>

            }
        </div>
        <div class="row mx-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#taskModal"
                    data-status="Done">
                Add Task
            </button>
        </div>
    </div>
</div>
<!-- Edit/Add Task Modal -->
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="taskModalLabel">Add Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <input type="hidden" id="TaskId" name="TaskId" />
                    <input type="hidden" id="ProjectId" name="ProjectId" value="@Model.Project_id" />
                    <input type="hidden" id="Status" name="Status" />
                    <div class="mb-3">
                        <label for="Title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="Title" name="Title" required />
                    </div>
                    <div class="mb-3">
                        <label for="Description" class="form-label">Description</label>
                        <textarea class="form-control" id="TaskDescription" name="Description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="AssignedTo" class="form-label">Assigned To</label>
                        <input type="text" class="form-control" id="AssignedTo" name="AssignedTo" />
                    </div>
                    <div class="mb-3">
                        <label for="DueDate" class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="DueDate" name="DueDate" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveTaskButton">Save Task</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this task?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var todoColumn = document.getElementById('todoColumn');
        var inProgressColumn = document.getElementById('inProgressColumn');
        var doneColumn = document.getElementById('doneColumn');
        var csrfToken = '@antiforgeryTokenSet.RequestToken';

        [todoColumn, inProgressColumn, doneColumn].forEach(function (column) {
            new Sortable(column, {
                group: 'shared',
                animation: 150,
                onEnd: function (evt) {
                    var taskId = evt.item.getAttribute('data-task-id');
                    var newStatus;
                    if (evt.to.id === 'todoColumn') {
                        newStatus = 'To Do';
                    } else if (evt.to.id === 'inProgressColumn') {
                        newStatus = 'In Progress';
                    } else if (evt.to.id === 'doneColumn') {
                        newStatus = 'Done';
                    }

                    fetch('/Tasks/UpdateStatus', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-TOKEN': csrfToken
                        },
                        body: JSON.stringify({ TaskId: taskId, Status: newStatus })
                    }).then(response => {
                        if (response.ok) {
                            var card = evt.item;
                            var updatedAtElement = card.querySelector('.updated-at');
                            var updatedAt = new Date().toLocaleString().replace(',', ''); // Remove comma
                            updatedAtElement.innerText = updatedAt;

                            updateTaskCounts();
                        } else {
                            console.error('Error updating task status');
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                    });
                }
            });
        });

        var updateTaskCounts = function () {
            var todoCount = todoColumn.children.length;
            var inProgressCount = inProgressColumn.children.length;
            var doneCount = doneColumn.children.length;

            document.getElementById('todoCountHeader').textContent = `To Do (${todoCount})`;
            document.getElementById('inProgressCountHeader').textContent = `In Progress (${inProgressCount})`;
            document.getElementById('doneCountHeader').textContent = `Done (${doneCount})`;
        };

        var taskModal = document.getElementById('taskModal');
        taskModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var taskId = button.getAttribute('data-task-id');
            var status = button.getAttribute('data-status');

            if (taskId) {
                fetch('/Tasks/GetTask/' + taskId)
                    .then(response => response.json())
                    .then(task => {
                        document.getElementById('TaskId').value = task.task_id;
                        document.getElementById('Title').value = task.title;
                        document.getElementById('TaskDescription').value = task.description;
                        document.getElementById('AssignedTo').value = task.assignedToUsername;
                        document.getElementById('DueDate').value = task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : '';
                        document.getElementById('Status').value = task.status;
                        document.getElementById('taskModalLabel').innerText = 'Edit Task';
                    });
            } else {
                document.getElementById('TaskId').value = '';
                document.getElementById('Title').value = '';
                document.getElementById('Description').value = '';
                document.getElementById('AssignedTo').value = '';
                document.getElementById('DueDate').value = '';
                document.getElementById('Status').value = status;
                document.getElementById('taskModalLabel').innerText = 'Add Task';
            }
        });

        document.getElementById('saveTaskButton').addEventListener('click', function () {
            var form = document.getElementById('taskForm');
            var formData = new FormData(form);
            var taskId = document.getElementById('TaskId').value;
            var url = taskId ? '/Tasks/Edit/' + taskId : '/Tasks/Add';

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': csrfToken
                },
                body: formData
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    console.error('Error saving task');
                }
            }).catch(error => {
                console.error('Error:', error);
            });
        });
        updateTaskCounts();
    });
    </script>
    <script>document.addEventListener('DOMContentLoaded', function () {
            var deleteButtons = document.querySelectorAll('.delete-task-button');
            var confirmDeleteButton = document.getElementById('confirmDeleteButton');
            var confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));

            deleteButtons.forEach(function (button) {
                button.addEventListener('click', function () {
                    var taskId = this.getAttribute('data-task-id');
                    confirmationModal.show();

                    confirmDeleteButton.addEventListener('click', function () {
                        fetch('/Tasks/Delete/' + taskId, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        }).then(response => {
                            if (response.ok || response.status === 200 || response.statusText.toLowerCase() === 'ok') {
                                confirmationModal.hide(); // Ẩn modal sau khi xóa thành công
                                location.reload(); // Reload the page after deleting the task

                            } else {
                                console.error('Error deleting task');
                            }
                        }).catch(error => {
                            console.error('Error:', error);
                        });
                    });
                });
            });
        });</script>

}